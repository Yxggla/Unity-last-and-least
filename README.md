# 第2章 系统设计

## 2.1 开发平台

### Unity3D引擎

Unity3D是一款跨平台的游戏开发引擎，提供了强大的3D渲染能力和丰富的开发工具。在本项目中，我们充分利用了Unity的多种功能，包括物理引擎、动画系统、粒子系统等，以实现丰富的游戏效果和流畅的游戏体验。

## 2.2 任务设计和实现思路

### 2.2.1 引擎使用方面

- **项目搭建**：创建新的Unity项目并进行基本设置，比如确定游戏的分辨率、帧率和目标平台。
- **场景设计**：使用Unity的场景编辑器进行详细设计。特别注重了灯光和阴影的设置，以提高场景的真实感。
- **资源管理**：建立了一个高效的资源管理系统，确保各种资源如模型、音效、脚本等可以快速导入和更新。

### 2.2.2 3D建模方面

- **模型创建**：在Blender中，对一些关键物品进行了手工建模，例如关卡中的关键道具或特殊建筑。
- **导入模型**：除了自制模型，还从网络获取了一些高质量的模型资源，经过适当的修改后导入Unity，确保它们与游戏风格保持一致。

### 2.2.3 3D骨骼绑定动画方面

- **角色模型与骨骼**：在Adobe的mixamo资源网站里下载游戏角色的3D模型并且是带T-pose的fbx。
- **动画制作**：在Adobe的mixamo资源网站里下载带游戏角色3D模型的动画。例如Idle、run、walk、attack等。
- **动画控制**：在Unity中创建动画控制器，实现动画在游戏中的控制逻辑，例如角色行走、跳跃等动作。其中利用创建动画器的参数，来控制每个动画之间的逻辑。

### 2.2.4 AI方面

- **路径规划**：使用寻路算法实现敌人寻找player的路径规划。通过AI组件，烘焙地面再给敌人添加Nav Mesh Agent和相关代码实现了敌人和player在一定距离内后敌人会主动走向player。

### 2.2.5 碰撞方面

- **碰撞体添加**：为游戏对象添加碰撞体组件。例如Mesh Collider或Box Collider。
- **碰撞检测**：编写脚本实现碰撞检测逻辑，处理碰撞事件。
- **碰撞后果**：有些碰撞会导致人物和物体的飞起来，利用脚本添加重力解决。

### 2.2.6 计分方面

- **计分系统设计**：设计游戏的计分规则和机制。例如捡石头部分，做了收集石头的个数的面板。血量和饥饿时间也做了相应的面板。
- **计分显示**：在界面上显示数据。在石头面板上可以看到捡到的石头个数。在血量和饥饿时间面板上可以看到剩余的血量和时间。

### 2.2.7 Camera方面

- **使用了3个摄像头**，分别是相机大脑的虚拟摄像头、和两个普通摄像头。
  - **相机大脑的虚拟摄像头**：可以跟随主角移动，鼠标可以控制摄像头位置和角度。虚拟摄像头始终跟随人物，并且lookat人物。
  - **普通摄像头1**：作为起始摄像头，负责游戏的第一个页面的展示，介绍游戏内容部分，并且添加了相应代码可以控制全场的面板等game object的默认开关为false。
  - **普通摄像头2**：作为小地图摄像头，投影改为正交，并且添加一个自定义渲染纹理，添加到小地图面板的图像上，即可实现小地图效果。

### 2.2.8 地形、背景方面

采用了Unity资源网站里的素材包，并进行一些删除和修改。游戏场景为空间站中，地形平坦，摄像机背景为宇宙照片。

### 2.2.9 声音方面

使用了3个声音。分别为星球大战的主题曲、开门音效、攻击音效。

- **星球大战的主题曲**：在游戏开始时，绑定在了一个空游戏对象上，这样可以全程播放这个bgm。
- **开门音效**：绑定在了密码界面上，当密码输入正确，并且正好开门时会播放。
- **攻击音效**：绑定在了attack的动作动画里，在打拳的那一帧添加一个事件帧，并且链接到player control的代码中的相关播放函数，实现攻击会有攻击音效。

精心挑选了适合各种场景的音效和音乐，并进行了适当的编辑，确保其与游戏场景的完美融合。

### 2.2.10 界面方面

创建多个界面，分别为密码界面、游戏成功、游戏失败、菜单、生存时间和血量和小地图、游戏介绍、卷轴密码、收集石头面板、npc小帅面板等

- **UI交互**：实现玩家与界面的交互，例如密码界面的按钮点击、菜单界面的继续和退出等。
- **在线多人游戏**：添加了在线多人游戏的场景，以及相关界面，在主游戏的进入部分的界面中添加了一个按钮可以跳转到在线多人游戏的场景。同理在在线多人游戏的场景中也创建了界面，有个按钮可以跳回主优秀场景。
- **PlayFab**：添加了PlayFab的登陆注册，以及优化了之前界面，在之前的界面中添加“继续游戏”、“保存游戏”等功能。

### 2.2.11 脚本方面

- **脚本开发**：编写了大量的C#脚本来实现游戏的核心功能，包括角色控制、游戏逻辑、事件处理等。
- **Mirror部分**：添加了Mirror部分、数据云存储部分。
  - 因为加入了数据云存储，所以创建了一个脚本来赋值所要存储的物体的初始化数据。这个功能也影响了所要存储的物体的相关代码。并且为数据云存储，做了单独的物体的代码，来做到存取的管理。以及添加了登陆、注册、继续游戏、保存游戏等按钮的相关代码函数。
  - 因为有Mirror部分，所以新写了一份人物控制代码，来适配Mirror的同步功能。
  - 优化了之前的输入密码时的人物会攻击的bug。
  - 添加了room2的食物自动刷新功能。

### 2.2.12 渲染方面

- **使用普通的渲染管线**，用材质上发射的HDR颜色，然后用照明烘焙的方式渲染。
- **渲染优化**：在保证视觉效果的同时，对游戏进行了深度优化，确保了高效的运行性能。

### 2.2.13 其他方面

- **模块化设计**：在游戏设计中多数采用了模块化的思路，使得未来可以方便地添加新内容或修改现有功能。
- **Mirror插件**：添加了Mirror插件，实现了在线局域网多人游戏。
- **人物预制件**：添加了人物预制件，全新的人物预制件添加上配合Mirror的相关人物控制代码，实现人物在局域网联机时的同步。
- **PlayFab网络存取**：添加了PlayFab的网络存取，实现了用户的登陆注册、保存数据和读取数据。
- **插件使用**：插件方面使用了HueFolders，给文件夹上色，使得工作的时候视觉感官更好。还用了Mirror、AI、Skybox、PlayFab、摄像机大脑等插件。
- **App发布**：还进行了App的发布，具体网址为：[https://yxggzhk.itch.io/quickrunyxgg](https://yxggzhk.itch.io/quickrunyxgg)
- **广告功能**：在广告功能进行了一些研究，但发现现存的Ads都是基于Android和iOS的移动端App的，对于端游的广告以及教程所剩无几，注册了一个Unity的Ads项目，但是只给了Android和iOS的ID，后续就没有完成。
- **支付功能**：在支付功能了进行了很多研究，其中主要尝试了支付宝的API支付功能，但是后续因为到要商家营业执照所以后续没能进展下去。

# 第3章 系统实现问题及解决

## 3.1 整体系统效果实现

1. **第一个画面**是一个面板，是一个欢迎页，有“进入”和“退出”两个选项。采用了一个第三人称摄像机的效果，拍摄到的内容有面板、太空站和地球。第一个画面添加了在线联机场景按钮，点击后可以跳转到在线联机场景（图1）

   ![图1](https://github.com/user-attachments/assets/ded42ad0-ff68-47dd-8595-f9a3099fdfb7)

2. **点击“进入”**后会跳转到第二个面板，其中利用点击按钮调用函数的方式，实现换页，同理可以点击“继续”跳转到下面的页面，页面的主要内容是剧情的大题介绍（图2）

   ![图2](https://github.com/user-attachments/assets/c2460191-14a1-431f-9923-193389a4f059)

3. **多次点击“继续”**后，会到一个有三个按钮分别为“开始游戏”、 “玩法介绍”、 “继续游戏”。也是利用点击按钮调用函数的方式，“开始游戏”的话会开关相关的摄像机、面板等，将游戏画面转移到室内的主角，并且开始更加细致的剧情介绍。点击“玩法介绍”会跳转到一个面板，内容是玩法的介绍，可以再点击返回回到此页面。点击“继续游戏”就会继续上次存档的游戏。（图3）

   ![图3](https://github.com/user-attachments/assets/9f02411d-3d01-4d73-96d3-53e323e8b9c2)

4. **点击开始游戏**后。开启虚拟摄像机，关闭刚刚的摄像机，并且开启相关的详细剧情介绍面板，其中需要按空格来继续。

5. **开始游戏**，需要密码才能离开room1，因此需要player在外星人还没靠近的时候击杀他们。其中有一个外星人被击杀后会生成一本书，在player碰到书的时候，会显示一个面板，面板里就是密码。（图4）

   ![图4](https://github.com/user-attachments/assets/95eeff3c-6d22-4c53-941e-1ede1f455ba6)

6. **靠近门后按E**会开始密码锁的面板，随后输入密码，在提交的时候会显示密码的正确与否。如果成功会跳出一个提醒事项的面板，之后门会打开。(图5)

   ![图5](https://github.com/user-attachments/assets/e75c0f9f-8499-48f4-b628-d7b20d5f9acb)

7. **门打开后**，会出现几个激光，激光会在3秒出现，3秒消失的循环。如果玩家不小心触碰到了激光就会扣血（图6）。在进入room2的时候会出现相关的剧情面板，告诉相关任务。

   ![图6](https://github.com/user-attachments/assets/51cc4357-a971-4a29-a2f6-a78104b1602e)

8. **room2中与room1一致**，击杀外星人获得密码，随后开门。补充每个房间中都会有三明治，用于增加饥饿剩余时间和血量。（图7）

   ![图7](https://github.com/user-attachments/assets/c03444c7-ca91-4b5d-a095-1e54e608ca90)

9. **与之前一致**，进入room3，会有一个详细剧情提醒告诉attack（鼠标左键）箱子，会有概率掉落修复能量塔的石头，随后收集到要求个数的石头再回到能量塔边，修复好能量塔，能量塔会变绿色，且会告诉下个房间密码（图8）

   ![图8](https://github.com/user-attachments/assets/9d52aebb-98ad-4d88-9b39-16f782f4c063)

10. **与之前一致**，进入room4，会有一个详细剧情提醒告诉找一本卷轴，里面有逃生舱的密码，并且逃生舱的灯的颜色为黄色（告诉了玩家哪扇门）

11. **玩家走到逃生舱**，走出一步就会弹出游戏胜利的面板。在逃生舱门外创建了一个透明的平面，并且添加了碰撞器和触发。

12. **其余的效果**还有菜单，可以实现相关功能。（图9）

    ![图9](https://github.com/user-attachments/assets/6569653e-bb1b-4160-833b-17111b9115bc)

13. **其余的效果**还有血量条、饥饿计时、小地图的面板。（图10）

    ![图10](https://github.com/user-attachments/assets/f67eeb6f-8589-47be-a13f-b75bb9eefca7)

## 3.2 遇到问题及其解决方案

- **问题1.摄像机**。作为一个第三人称视角的游戏，我要研究摄像机如何跟随人物的移动，鼠标如何自由控制转动。
  - **解决方案**：在网上学习了相机大脑插件的使用，随后使用相机大脑中的虚拟相机，通过跟随和look at和其他的细调，完成了现在的第三人称视角。

- **问题2.人物的卡模型**。我的人物在奔跑动作的时候朝向箱子就会慢慢卡上箱子上方。但是继续移动人物却不下来。尝试了很多碰撞体，但发现不是这个的问题。
  - **解决方案**：在人物移动的代码中，在update中添加重力的函数，这样人物在卡上箱子后，之后可以自然的下落回到地面。也尝试用了把地面设置一个标签为ground，然后人物只能在ground上运动，发现效果不如添加重力代码好用。

- **问题3.敌人攻击玩家**。由于代码中设置的是距离在多少以内的时候会朝向人物走，在距离小于多少多少的时候扣血。由于是update，所以人物会被秒杀。同理人物碰到激光也会被秒。
  - **解决方案**：在代码中添加一个协程并且添加个布尔，可以做到过几秒之后设置布尔的值，在可以攻击的时候才能有扣血。实现了几秒扣一次血，不会被秒杀。在激光问题中，因为给激光添加了碰撞体，所以可以设置人物走进的时候一个布尔值，走出去一个布尔值。

- **问题4.在使用虚拟摄像机的时候**，很难刚开始就将鼠标默认放在游戏中心。
  - **解决方案**：取巧的在开启虚拟摄像机的之前，把开始游戏的按钮放在游戏画布正中心。
